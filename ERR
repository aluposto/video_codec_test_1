# Run test_video.py as a subprocess (recommended â€” avoids multiprocessing pickling errors)
import subprocess, sys, os
from pathlib import Path

repo_root = Path("/home/work/dcvc/dcvc_try_p").resolve()
# ensure the subprocess sees repo_root on PYTHONPATH
env = os.environ.copy()
env["PYTHONPATH"] = str(repo_root) + (":" + env.get("PYTHONPATH", "")) if env.get("PYTHONPATH") else str(repo_root)

cmd = [
    sys.executable, str(repo_root / "test_video.py"),
    "--model_path_i", "./checkpoints/cvpr2025_image.pth.tar",
    "--model_path_p", "./checkpoints/cvpr2025_video.pth.tar",
    "--rate_num", "4",
    "--test_config", "./dataset_config_example_yuv420.json",
    "--cuda", "1",
    "-w", "1",
    "--write_stream", "1",
    "--force_zero_thres", "0.12",
    "--output_path", "output.json",
    "--force_intra_period", "-1",
    "--reset_interval", "64",
    "--force_frame_num", "-1",
    "--check_existing", "0",
    "--verbose", "0",
]

print("Running:", " ".join(cmd))
proc = subprocess.Popen(cmd, env=env, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, bufsize=1)

# Stream output live to notebook
try:
    for line in proc.stdout:
        print(line, end="")   # already contains newline
except KeyboardInterrupt:
    proc.terminate()
    proc.wait()
    print("\nSubprocess terminated by user.")











Running: /home/work/dcvc/miniconda3/envs/dcvc_rt_env_1/bin/python /home/work/dcvc/dcvc_try_p/test_video.py --model_path_i ./checkpoints/cvpr2025_image.pth.tar --model_path_p ./checkpoints/cvpr2025_video.pth.tar --rate_num 4 --test_config ./dataset_config_example_yuv420.json --cuda 1 -w 1 --write_stream 1 --force_zero_thres 0.12 --output_path output.json --force_intra_period -1 --reset_interval 64 --force_frame_num -1 --check_existing 0 --verbose 0
cannot import cuda implementation for inference, fallback to pytorch.
testing 4 rates, using qp: 0, 21, 42, 63, 

  0%|          | 0/212 [00:00<?, ?it/s]cannot import cuda implementation for inference, fallback to pytorch.
Exception in initializer:
Traceback (most recent call last):
  File "/home/work/dcvc/miniconda3/envs/dcvc_rt_env_1/lib/python3.12/concurrent/futures/process.py", line 243, in _process_worker
    initializer(*initargs)
  File "/home/work/dcvc/dcvc_try_p/test_video.py", line 403, in init_func
    i_frame_net.update(args.force_zero_thres)
  File "/home/work/dcvc/dcvc_try_p/src/models/common_model.py", line 50, in update
    self.entropy_coder = EntropyCoder()
                         ^^^^^^^^^^^^^^
  File "/home/work/dcvc/dcvc_try_p/src/models/entropy_models.py", line 15, in __init__
    from MLCodec_extensions_cpp import RansEncoder, RansDecoder
ModuleNotFoundError: No module named 'MLCodec_extensions_cpp'

  0%|          | 0/212 [00:05<?, ?it/s]
Traceback (most recent call last):
  File "/home/work/dcvc/dcvc_try_p/test_video.py", line 541, in <module>
    main()
  File "/home/work/dcvc/dcvc_try_p/test_video.py", line 514, in main
    result = obj.result()
             ^^^^^^^^^^^^
  File "/home/work/dcvc/miniconda3/envs/dcvc_rt_env_1/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/home/work/dcvc/miniconda3/envs/dcvc_rt_env_1/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
concurrent.futures.process.BrokenProcessPool: A process in the process pool was terminated abruptly while the future was running or pending.

Subprocess finished with return code: 1
finally:
    proc.stdout.close()
    rc = proc.wait()
    print(f"\nSubprocess finished with return code: {rc}")
